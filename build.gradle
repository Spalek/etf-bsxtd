///////////////////////////////////////////////////////////////////////////////////////
// 
// ETF-BsxTD
// 
///////////////////////////////////////////////////////////////////////////////////////

buildscript {
	repositories {
		maven {
			url "http://services.interactive-instruments.de/etfdev-af/plugins-releases-local"
			credentials {
				username 'ii-bda'
				password '6ozhS683'
			}}
		maven {
			url "https://plugins.gradle.org/m2/"
		}
		jcenter()
	}
	dependencies {
		classpath group: 'de.interactive_instruments.bda', name: 'etf-bda', version:'1.0.+'
		classpath 'net.researchgate:gradle-release:2.3.4'
		classpath "gradle.plugin.nl.javadude.gradle.plugins:license-gradle-plugin:0.12.1"
	}
	dependencies {
		ant.unjar src: configurations.classpath.files.find {it.path.contains('etf')}, dest: 'build/gradle'
	}
}
apply from: 'build/gradle/ii-bda.gradle'

///////////////////////////////////////////////////////////////////////////////////////

group = 'de.interactive_instruments.etf.testdriver'
description = "ETF BaseX test driver"


ext.testDataDir = project.hasProperty('etf.td.deployment.dir') ?
		project.getProperty('etf.td.deployment.dir') :
		project.file('./build/tmp/td')

repositories {
	mavenLocal()

	// BaseX
	maven { url 'http://files.basex.org/maven' }  
}

dependencies {

    compile group: 'de.interactive_instruments', name: 'ii-commons-util', version:'1.2.6'+project.snapshotSuffix
    compile group: 'de.interactive_instruments.etf', name: 'etf-model', version:'0.5.7'+project.snapshotSuffix

	compile group: 'commons-logging', name: 'commons-logging', version:'1.1.1'
	compile group: 'commons-io', name: 'commons-io', version:'2.4'

	// BaseX
	compile group: 'org.basex', name: 'basex', version:'7.9'


	// Required by BaseX extensions, must be placed in the lib folder because
	// the extension class loader will not initialize 3rd party libraries correctly
	compile group: 'xerces', name: 'xercesImpl', version:'2.11.0.beta'
	compile group: 'xml-apis', name: 'xml-apis', version:'1.4.01'
	compile('dom4j:dom4j:1.6.1') {
		exclude group: 'xml-apis'
	}
	compile('xalan:xalan:2.7.2') {
		exclude group: 'xerces'
		exclude group: 'xml-apis'
	}


	testCompile group: 'junit', name: 'junit', version: '4.11'
}

task sourcesJar(type: Jar, dependsOn: classes) {
	description = 'Creates jars with the sourcecode'
	classifier 'source'
	from sourceSets.main.allSource
}

task copyTdToTdDir(dependsOn: jar) << {
	copy {
		from jar
		into "$testDataDir/bsx/bin"
	}
	println "Copied test driver to $testDataDir"
}

def allLibs = configurations.runtime + configurations.compile -
		configurations.compile.filter { it.name.startsWith('etf-model') } -
		configurations.compile.filter { it.name.startsWith('ii-commons-util') } -
		configurations.compile.filter { it.name.startsWith('slf4j-api') } -
		configurations.compile.filter { it.name.startsWith('jetty') } -
		configurations.compile.filter { it.name.startsWith('xml-apis') } -
		configurations.compile.filter { it.name.startsWith('log4j') }

task copyLibsToTdDir << {
	copy {
		from allLibs
		into "$testDataDir/bsx/lib"
	}
}

install {
	dependsOn = ["driverZip", "copyTdToTdDir", "copyLibsToTdDir"]
}

task driverZip(type: Zip) {
	baseName = 'etf-bsxtd'
	into('bsx/bin') {
		from jar
	}
	into('bsx/lib') {
		from allLibs
	}
}

artifacts {
	archives driverZip
}
